<!doctype html>
<html lang="jp">
  <head>
    <title>Potal4BO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/ripples.min.css">
    <link rel="stylesheet" href="/css/material-wfont.min.css">
    <style>
      body {
        padding-top: 20px;
      }
      
      /* for bootstrap */
      .form-control-wrapper {
        margin-bottom: 20px;
      }
      .btn {
        padding: 5px 20px;
      }
      
      /* for vuejs */
      [v-cloak] {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="result" class="row">
        <form class="form-inline" role="form">
          <div class="input-group">
            <select class="form-control" id="pair" v-model="form.pair" options="pairs" v-cloak></select>
          </div>
          <button type="button" class="btn btn-primary btn-xs" v-on="click: search">
            <span class="glyphicon glyphicon-th-list" aria-hidden="true"></span>
          </button>
        </form>

        <h3 v-cloak>
          <span class="mdi-social-notifications-on" aria-hidden="true"></span> {{deviation | fixed3}}
        </h3>

        <table class="table table-striped table-bordered table-condensed">
          <thead>
            <tr>
              <th>DATE</th>
              <th>RATE</th>
              <th class="hidden-xs">EMA12</th>
              <th class="hidden-xs">EMA26</th>
              <th>MACD</th>
              <th class="hidden-xs">SIGNAL</th>
              <th>JUDGE</th>
              <th>2σ</th>
            </tr>
          </thead>
          <tbody>
            <tr v-repeat="r : rates" v-class="success : r.ORDER, warning : r.WARN, danger: r.PAY" v-cloak>
              <td>{{r.日付}}<br class="visible-xs-inline"> {{r.時間}}</td>
              <td class="text-right">{{r.終値 | fixedB}}</td>
              <td class="text-right hidden-xs">{{r.EMA12 | fixedA}}</td>
              <td class="text-right hidden-xs">{{r.EMA26 | fixedA}}</td>
              <td class="text-right">{{r.MACD | fixedA}} {{r.MACD_D}}</td>
              <td class="text-right hidden-xs">{{r.SIGNAL | fixedA}}</td>
              <td class="text-right">{{r.JUDGE | fixedA}} {{r.JUDGE_D}}</td>
              <td class="text-right">{{r.SD_DIFF | fixedB}} {{r.S2_FIG}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/ripples.min.js"></script>
    <script src="/js/material.min.js"></script>
    <script src="/js/vue.min.js"></script>
    <script>
    //
    jQuery(function($) {

        $.material.init();
 
        var memoFixed = function(scale) {
            return function (val) {return val.toFixed(scale);}
        };
        var getCurrentTerm = function() {
            var startTime, endTime, now = new Date();
            if (now.getHours() >= 23 || now.getHours() < 1) {
              startTime = "22:00", endTime = "01:00";
            } else if (now.getHours() < 3) {
              startTime = "00:00", endTime = "03:00";
            } else if (now.getHours() < 5) {
              startTime = "02:00", endTime = "05:00";
            } else if (now.getHours() < 11) {
              startTime = "08:00", endTime = "11:00";
            } else if (now.getHours() < 13) {
              startTime = "10:00", endTime = "13:00";
            } else if (now.getHours() < 15) {
              startTime = "12:00", endTime = "15:00";
            } else if (now.getHours() < 17) {
              startTime = "14:00", endTime = "17:00";
            } else if (now.getHours() < 19) {
              startTime = "16:00", endTime = "19:00";
            } else if (now.getHours() < 21) {
              startTime = "18:00", endTime = "21:00";
            } else if (now.getHours() < 23) {
              startTime = "20:00", endTime = "23:00";
            }
            return startTime + "〜" + endTime;
        }
        
        Vue.filter('fixed3', memoFixed(3));
       
        var rateVue = new Vue({
          el: '#result',
          data: {
            pairs: ["USDJPY","EURJPY","GBPJPY","EURUSD"],
            form: {pair: "USDJPY"},
            message: '',
            deviation: 0.00,
            options: [],
            rates: []
          },
          methods: {
            search : function() {
              var $data = this.$data;
              // 送信
              $.ajax({
                url: '/rate/' + $('#pair').val() + "/5min",
                type: 'GET',
                dataType: 'json'
              }).done(function(result) {
                
      
                // 書式指定
                var containsJPY = $("#pair").val().match(/.{3}JPY/);
                if (containsJPY) {
                  Vue.filter('fixedA', memoFixed(2));
                  Vue.filter('fixedB', memoFixed(3));
                } else {
                  Vue.filter('fixedA', memoFixed(3));
                  Vue.filter('fixedB', memoFixed(4));
                }

                // シグナル設定
                var preItem = {}, lastSD = '';
                var signD = function(preItem, item, name) {return (preItem[name] <= item[name] ? '△' : '▼');};
                $.each(result, function(i, item) {
                    
                    if (!containsJPY) {
                      $.each(['MACD', 'SIGNAL', 'JUDGE', 'SD', 'SD_DIFF'], function(i, n) {item[n] = item[n] * 100;});
                    }
                  
                    item['MACD_D'] = signD(preItem, item, 'MACD');
                    item['JUDGE_D'] = signD(preItem, item, 'JUDGE');
                    item['S2_P_D'] = signD(preItem, item, 'S2_P');
                    item['S2_M_D'] = signD(preItem, item, 'S2_M');
                    item['S2_FIG'] = (item['S2_P_D'] == item['S2_M_D'] ? item['S2_P_D'] : (item['S2_P_D'] == "△" ? "＜" : "＞"));
                    
                    item['ORDER'] = (Math.abs(preItem['SD_DIFF']) < Math.abs(item['SD_DIFF']) && item['MACD_D'] == item['JUDGE_D'] && item['S2_FIG'] == '＜');
                    item['WARN'] = (item['MACD_D'] == item['JUDGE_D'] && item['MACD_D'] == "▼" && item['S2_FIG'] == '△')
                                || (item['MACD_D'] == item['JUDGE_D'] && item['MACD_D'] == "△" && item['S2_FIG'] == '▼');
                    item['PAY'] = (Math.abs(preItem['SD_DIFF']) > Math.abs(item['SD_DIFF']) && item['S2_FIG'] == '＞');
                    
                    lastSD = item['SD'];
                    preItem = item;
                });
                
                var itemList = [];
                $.each(result, function(i, item) {
                    if (i >= result.length - 10) {
                      itemList.push(item);
                    }
                });
                // データ反映
                $data.message = getCurrentTerm();
                $data.rates = itemList;
                $data.deviation = lastSD;
              });
            }
          }
        });
        
        rateVue.$data.message = getCurrentTerm();
        
    });      
    </script>
    </body>
</html>
