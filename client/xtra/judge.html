<!doctype html>
<html lang="jp">
  <head>
    <title>postrate</title>
    <meta name="viewport" content="width=device-width">
    <!--
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    -->
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/ripples.min.css">
    <link rel="stylesheet" href="/css/material-wfont.min.css">
    <style>
      body {
        padding-top: 20px;
      }
      
      /* for bootstrap */
      .form-control-wrapper {
        margin-bottom: 20px;
      }
      .btn {
        padding: 5px 20px;
      }
      
      /* for vuejs */
      [v-cloak] {
        display: none;
      }

      /* for d3js */
      .axis {
        font-size: 0.6em;
      }
      .tick {
        fill: none;
        stroke: gray;
      }
      path {
        fill: none;
        stroke: lightgrey;
        stroke-width: 1px;
      }
      circle {
        stroke: nlack;
        stroke-width: 0.5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="result" class="row">
        <form class="form-inline" role="form">
          <div class="input-group">
            <select class="form-control" id="pair" v-model="form.pair" options="pairs" v-cloak></select>
          </div>
          <div class="input-group">
            <select class="form-control" id="tr" v-model="form.term" options="terms" v-cloak></select>
          </div>
          <button type="button" class="btn btn-primary btn-xs" v-on="click: search">
            <span class="glyphicon glyphicon-th-list" aria-hidden="true"></span>
          </button>
        </form>
        <div id="linechart"></div>
        <table class="table table-striped table-bordered table-condensed">
          <thead>
            <tr>
              <th>DATE</th>
              <th>RATE</th>
              <th class="hidden-xs">EMA12</th>
              <th class="hidden-xs">EMA26</th>
              <th>MACD</th>
              <th class="hidden-xs">SIGNAL</th>
              <th>JUDGE</th>
              <th>2σ</th>
            </tr>
          </thead>
          <tbody>
            <tr v-repeat="r : rates" v-class="success : r.ORDER, warning : r.WARN, danger: r.PAY" v-cloak>
              <td>{{r.日付}}<br class="visible-xs-inline"> {{r.時間}}</td>
              <td class="text-right">{{r.終値 | fixedB}}</td>
              <td class="text-right hidden-xs">{{r.EMA12 | fixedA}}</td>
              <td class="text-right hidden-xs">{{r.EMA26 | fixedA}}</td>
              <td class="text-right">{{r.MACD | fixedA}} {{r.MACD_D}}</td>
              <td class="text-right hidden-xs">{{r.SIGNAL | fixedA}}</td>
              <td class="text-right">{{r.JUDGE | fixedA}} {{r.JUDGE_D}}</td>
              <td class="text-right">{{r.SD_DIFF | fixedB}} {{r.S2_FIG}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/ripples.min.js"></script>
    <script src="/js/material.min.js"></script>
    <script src="/js/vue.min.js"></script>
    <script src="/js/d3.min.js"></script>
    <script src="/js/app_chart.js"></script>
    <script>
    //
    jQuery(function($) {

        $.material.init();
        
        var rateVue = new Vue({
          el: '#result',
          data: {
            pairs: ["USDJPY","EURJPY","GBPJPY","AUDJPY","NZDJPY","EURUSD","GBPUSD","AUDUSD","CHFUSD"],
            terms: ["5min","15min","1h","4h","1d"],
            form:  {pair:"USDJPY", term: "1d"},
            rates: []
          },
          methods: {
            search : function() {
              var $data = this.$data;
              // 送信
              $.ajax({
                url: '/rate/' + $('#pair').val() + "/" + $('#tr').val(),
                type: 'GET',
                dataType: 'json'
              }).done(function(result) {
      
                // 書式指定
                var containsJPY = $("#pair").val().match(/.{3}JPY/);
                if (containsJPY) {
                  Vue.filter('fixedA', {read: function (val) {return val.toFixed(2);}});
                  Vue.filter('fixedB', {read: function (val) {return val.toFixed(3);}});
                } else {
                  Vue.filter('fixedA', {read: function (val) {return val.toFixed(3);}});
                  Vue.filter('fixedB', {read: function (val) {return val.toFixed(4);}});
                }

                // シグナル設定
                var preItem = {};
                var signD = function(preItem, item, name) {return (preItem[name] <= item[name] ? '△' : '▼');};
                $.each(result, function(i, item) {
                    
                    if (!containsJPY) {
                      $.each(['MACD', 'SIGNAL', 'JUDGE', 'SD', 'SD_DIFF'], function(i, n) {item[n] = item[n] * 100;});
                    }
                  
                    item['MACD_D'] = signD(preItem, item, 'MACD');
                    item['JUDGE_D'] = signD(preItem, item, 'JUDGE');
                    item['S2_P_D'] = signD(preItem, item, 'S2_P');
                    item['S2_M_D'] = signD(preItem, item, 'S2_M');
                    item['S2_FIG'] = (item['S2_P_D'] == item['S2_M_D'] ? item['S2_P_D'] : (item['S2_P_D'] == "△" ? "＜" : "＞"));
                    
                    item['ORDER'] = (Math.abs(preItem['SD_DIFF']) < Math.abs(item['SD_DIFF']) && item['MACD_D'] == item['JUDGE_D'] && item['S2_FIG'] == '＜');
                    item['WARN'] = (item['MACD_D'] == item['JUDGE_D'] && item['MACD_D'] == "▼" && item['S2_FIG'] == '△')
                                || (item['MACD_D'] == item['JUDGE_D'] && item['MACD_D'] == "△" && item['S2_FIG'] == '▼');
                    item['PAY'] = (Math.abs(preItem['SD_DIFF']) > Math.abs(item['SD_DIFF']) && item['S2_FIG'] == '＞');
                    preItem = item;
                });
                
                var itemList = [];
                $.each(result, function(i, item) {
                    if (i >= result.length - 10) {
                      itemList.push(item);
                    }
                });

                // データ反映
                $data.rates = itemList;
                
                // グラフ描画
                drawChart(d3, $, "#linechart", result);
                  
              });
            }
          }
        });
    });      
    </script>
    </body>
</html>
